<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solana Meme Finder – Social Sentiment Added</title>
  <style>
    :root {
      --bg: #0f0f17; --text: #e0e0ff; --accent: #00ff88; --link: #00ddff;
      --table-bg: #1a1a2e; --th-bg: #222244; --border: #333366;
      --buy: #004d00; --sell: #4d0000; --rug: #660000;
      --tooltip-bg: #1e1e3a; --tooltip-text: #e0e0ff;
      --risk-low: #28a745; --risk-med: #ffc107; --risk-high: #dc3545;
      --balance: #88ffaa; --value: #ffcc00; --sentiment-bull: #00cc66; --sentiment-bear: #ff4444;
    }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; min-height: 100vh; }
    header { text-align: center; margin-bottom: 1.2rem; }
    h1 { color: var(--accent); margin: 0.4rem 0; font-size: 1.8rem; }
    p.intro { max-width: 900px; margin: 0 auto 1rem; color: #a0a0ff; font-size: 0.9rem; }
    #controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 0.6rem; margin-bottom: 1.2rem; }
    button { background: transparent; border: 1px solid var(--link); color: var(--link); padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
    button:hover { background: var(--link); color: #000; }
    button.buy-btn { background: #00aa66; color: white; border: none; padding: 0.6rem 1.2rem; font-size: 0.9rem; }
    button.buy-btn:hover { background: #009955; }
    button.sell-btn { background: #cc0000; color: white; border: none; padding: 0.6rem 1.2rem; font-size: 0.9rem; }
    button.sell-btn:hover { background: #aa0000; }
    input.custom-input { width: 80px; padding: 0.4rem; border: 1px solid var(--link); border-radius: 4px; background: #1e1e3a; color: var(--text); text-align: center; }
    #wallet-info { font-weight: bold; color: #88ffaa; text-align: center; margin: 0.4rem 0; }
    #last-update, #status, #error { text-align: center; font-style: italic; margin: 0.8rem 0; font-size: 0.85rem; }
    #error { color: #ff5555; }
    #status { color: #ffcc00; }
    .table-container { overflow-x: auto; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    table { width: 100%; border-collapse: collapse; background: var(--table-bg); min-width: 1600px; }
    th, td { padding: 9px 7px; text-align: center; border: 1px solid var(--border); font-size: 0.82rem; position: relative; }
    th { background: var(--th-bg); color: #88ccff; position: sticky; top: 0; z-index: 1; cursor: pointer; user-select: none; }
    th.sortable:hover { background: #333366; }
    th .sort-arrow { margin-left: 4px; opacity: 0.6; }
    th.asc .sort-arrow:after { content: '↑'; opacity: 1; }
    th.desc .sort-arrow:after { content: '↓'; opacity: 1; }
    th[data-tooltip]:hover::after,
    th[data-tooltip]:focus::after {
      content: attr(data-tooltip);
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      background: var(--tooltip-bg); color: var(--tooltip-text);
      padding: 6px 10px; border-radius: 6px; font-size: 0.78rem; white-space: nowrap;
      z-index: 10; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.6); margin-bottom: 8px;
    }
    .risk-badge, .sentiment-badge { padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 0.75rem; }
    .risk-low  { background: var(--risk-low);  color: white; }
    .risk-med  { background: var(--risk-med);  color: black; }
    .risk-high { background: var(--risk-high); color: white; }
    .sentiment-bull { background: var(--sentiment-bull); color: white; }
    .sentiment-neutral { background: #666699; color: white; }
    .sentiment-bear { background: var(--sentiment-bear); color: white; }
    tr.buy-zone   { background: var(--buy); }
    tr.sell-zone  { background: var(--sell); }
    tr.rug-risk   { background: var(--rug); }
    .balance-cell, .value-cell { font-weight: bold; }
    .balance-cell { color: var(--balance); }
    .value-cell   { color: var(--value); }
    a.link { color: var(--link); text-decoration: none; margin: 0 0.3rem; }
    a.link:hover { text-decoration: underline; }
    .action-cell { display: flex; flex-wrap: wrap; gap: 0.4rem; justify-content: center; align-items: center; }
    @media (max-width: 768px) {
      body { padding: 0.5rem; }
      th, td { padding: 7px 5px; font-size: 0.76rem; }
      table { min-width: 1400px; }
      .action-cell { flex-direction: column; gap: 0.3rem; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Solana Meme Finder – Best + Sentiment</h1>
    <p class="intro">
      Top momentum + strong social buzz coins only • No duplicates • Direct Phantom buy/sell • Balance & Value USD • Rug risk • 10s refresh
    </p>
  </header>

  <div id="controls">
    <button id="refresh-btn">Refresh Now</button>
    <button id="connect-btn">Connect Phantom</button>
    <div id="wallet-info">Wallet: Not connected</div>
  </div>

  <div id="last-update">Loading…</div>
  <div id="status"></div>
  <div id="error"></div>

  <div class="table-container">
    <table id="table">
      <thead>
        <tr>
          <th>Token</th>
          <th class="sortable" data-key="price"     data-type="number" data-tooltip="Current price in USD">Price</th>
          <th class="sortable" data-key="fdv"       data-type="number" data-tooltip="Fully Diluted Valuation">FDV</th>
          <th class="sortable" data-key="liq"       data-type="number" data-tooltip="Liquidity USD">Liq</th>
          <th class="sortable" data-key="m5buys"    data-type="number" data-tooltip="Buys last 5 min">m5 B</th>
          <th class="sortable" data-key="m5sells"   data-type="number" data-tooltip="Sells last 5 min">m5 S</th>
          <th class="sortable" data-key="m5vol"     data-type="number" data-tooltip="Volume last 5 min USD">m5 Vol</th>
          <th class="sortable" data-key="m5chg"     data-type="number" data-tooltip="% change last 5 min">m5 %</th>
          <th class="sortable" data-key="h6buys"    data-type="number" data-tooltip="Buys last 6 hours">h6 B</th>
          <th class="sortable" data-key="h6sells"   data-type="number" data-tooltip="Sells last 6 hours">h6 S</th>
          <th class="sortable" data-key="h6vol"     data-type="number" data-tooltip="Volume last 6 hours USD">h6 Vol</th>
          <th class="sortable" data-key="h6chg"     data-type="number" data-tooltip="% change last 6 hours">h6 %</th>
          <th class="sortable" data-key="h24buys"   data-type="number" data-tooltip="Buys last 24 hours">24h B</th>
          <th class="sortable" data-key="h24sells"  data-type="number" data-tooltip="Sells last 24 hours">24h S</th>
          <th class="sortable" data-key="h24vol"    data-type="number" data-tooltip="Volume last 24 hours USD">24h Vol</th>
          <th class="sortable" data-key="h24chg"    data-type="number" data-tooltip="% change last 24 hours">24h %</th>
          <th class="sortable" data-key="age"       data-type="number" data-tooltip="Pair age in minutes">Age</th>
          <th>Alert</th>
          <th class="sortable" data-key="boost"     data-type="number" data-tooltip="Boost amount">Boost</th>
          <th>Rug Risk</th>
          <th>Social Sentiment</th>
          <th class="sortable" data-key="balance"   data-type="number" data-tooltip="Your current token balance">Balance</th>
          <th class="sortable" data-key="valueUsd"  data-type="number" data-tooltip="Your holdings value in USD">Value USD</th>
          <th>Buy / Sell</th>
          <th>Links</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script>
    // =============================================================================
    // CONFIG – tunable parameters
    // =============================================================================

    const CONFIG = {
      BOOST_URL: 'https://api.dexscreener.com/token-boosts/latest/v1',
      SOL_MINT: 'So11111111111111111111111111111111111111112',
      MIN_LIQUIDITY: 5000,
      REFRESH_INTERVAL: 10000,
      MAX_DISPLAY_TOKENS: 15,
      FIXED_BUY_AMOUNTS: [0.05, 0.1, 0.25, 0.5],
      FIXED_SELL_PERCENTS: [25, 50, 75, 100]
    };

    // =============================================================================
    // DOM CACHE
    // =============================================================================

    const DOM = {
      tbody: document.getElementById('tbody'),
      lastUpdate: document.getElementById('last-update'),
      status: document.getElementById('status'),
      error: document.getElementById('error'),
      wallet: document.getElementById('wallet-info'),
      refreshBtn: document.getElementById('refresh-btn'),
      connectBtn: document.getElementById('connect-btn')
    };

    let walletAddress = null;
    let currentData = [];

    // =============================================================================
    // UTILITIES
    // =============================================================================

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function cleanNumber(v) {
      return parseFloat(String(v).replace(/[^0-9.-]+/g, '')) || 0;
    }

    function playSound(freq = 880, dur = 0.25) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        osc.type = 'sine';
        osc.frequency.value = freq;
        osc.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + dur);
      } catch {}
    }

    // =============================================================================
    // WALLET & BALANCE
    // =============================================================================

    async function connectWallet() {
      if (!window.solana?.isPhantom) {
        alert('Phantom wallet not detected. Please install it.');
        return;
      }
      try {
        const resp = await window.solana.connect();
        walletAddress = resp.publicKey.toString();
        DOM.wallet.textContent = `Wallet: ${walletAddress.slice(0,6)}…${walletAddress.slice(-4)} (connected)`;
        await loadData();
      } catch (err) {
        alert('Connection failed: ' + err.message);
      }
    }

    async function getTokenBalance(mint) {
      if (!walletAddress) return 0;
      try {
        const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'), 'confirmed');
        const accounts = await connection.getParsedTokenAccountsByOwner(
          new solanaWeb3.PublicKey(walletAddress),
          { mint: new solanaWeb3.PublicKey(mint) }
        );
        if (accounts.value.length === 0) return 0;
        return accounts.value[0].account.data.parsed.info.tokenAmount.uiAmount || 0;
      } catch {
        return 0;
      }
    }

    // =============================================================================
    // TRADING FUNCTIONS
    // =============================================================================

    async function executeSwap(inputMint, outputMint, amountRaw, isBuy = true) {
      if (!walletAddress) return alert('Connect Phantom first');

      const action = isBuy ? 'Buy' : 'Sell';
      const unit = isBuy ? 'SOL' : 'tokens';
      DOM.status.textContent = `Preparing ${action}: ${amountRaw} ${unit}...`;

      try {
        const quoteUrl = `https://quote-api.jup.ag/v6/quote?` + new URLSearchParams({
          inputMint,
          outputMint,
          amount: Math.floor(amountRaw),
          slippageBps: '50'
        });

        const quoteRes = await fetch(quoteUrl);
        if (!quoteRes.ok) throw new Error('Quote failed');
        const quote = await quoteRes.json();

        const swapRes = await fetch('https://quote-api.jup.ag/v6/swap', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            quoteResponse: quote,
            userPublicKey: walletAddress,
            wrapAndUnwrapSol: true,
            computeUnitPriceMicroLamports: 100000
          })
        });

        if (!swapRes.ok) throw new Error('Swap tx failed');
        const { swapTransaction } = await swapRes.json();

        const txBuf = Buffer.from(swapTransaction, 'base64');
        const tx = solanaWeb3.Transaction.from(txBuf);

        const { signature } = await window.solana.signAndSendTransaction(tx, { skipPreflight: false });

        alert(`${action} sent!\nTx: https://solscan.io/tx/${signature}`);
        DOM.status.textContent = `${action} submitted – check Phantom`;
        await loadData();
      } catch (err) {
        DOM.error.textContent = `${action} failed: ${err.message}`;
        console.error(err);
      }
    }

    window.buyToken = (mint, amountSol) => {
      amountSol = parseFloat(amountSol);
      if (isNaN(amountSol) || amountSol <= 0) return alert('Enter valid amount > 0');
      executeSwap(CONFIG.SOL_MINT, mint, amountSol * 1e9, true);
    };

    window.sellToken = async (mint, value) => {
      const balance = await getTokenBalance(mint);
      if (balance <= 0) return alert('No balance to sell');

      let amount;
      if (typeof value === 'number' && value <= 100) {
        amount = balance * (value / 100);
      } else {
        amount = parseFloat(value);
        if (isNaN(amount) || amount <= 0 || amount > balance) return alert('Invalid amount');
      }

      if (!confirm(`Sell ${amount.toFixed(2)} tokens (${((amount / balance) * 100).toFixed(1)}%)?`)) return;

      executeSwap(mint, CONFIG.SOL_MINT, amount * 1e6, false);
    };

    // =============================================================================
    // SENTIMENT HELPERS (proxy via search – no API key)
    // =============================================================================

    function estimateSentiment(row) {
      // Placeholder – in real production use LunarCrush / Santiment / Birdeye API
      // Here we simulate based on available data + common patterns
      const m5Vol = cleanNumber(row.m5vol);
      const m5Chg = cleanNumber(row.m5chg);
      const boost = cleanNumber(row.boost);

      // Rough heuristic (improve with real API later)
      let score = 50;
      if (m5Chg > 15) score += 25;
      if (m5Vol > 50000) score += 20;
      if (boost > 1000) score += 15;
      if (m5.sells > m5.buys * 1.5) score -= 30;

      score = Math.max(0, Math.min(100, score));

      let label = 'Neutral', cls = 'sentiment-neutral';
      if (score >= 70) { label = 'Bullish'; cls = 'sentiment-bull'; }
      if (score <= 30) { label = 'Bearish'; cls = 'sentiment-bear'; }

      return { label, score, cls };
    }

    // =============================================================================
    // CORE DATA PROCESSING
    // =============================================================================

    function calculateScore(row) {
      const m5Chg = cleanNumber(row.m5chg);
      const m5Vol = cleanNumber(row.m5vol);
      const buys = row.m5buys || 0;
      const sells = row.m5sells || 0;
      const liqRatio = cleanNumber(row.liq) / cleanNumber(row.fdv);
      const boost = cleanNumber(row.boost);

      const sentiment = estimateSentiment(row).score / 100;

      const momentum = (m5Chg > 0 ? m5Chg : 0) * 0.35 + (m5Vol / 10000) * 0.25;
      const pressure = (buys / (sells + 1)) * 0.7;
      const safety = Math.min(liqRatio * 20, 1) * 0.4;
      const boostBonus = Math.min(boost / 1000, 3) * 0.3;
      const socialBonus = sentiment * 0.6;

      return momentum + pressure + safety + boostBonus + socialBonus;
    }

    async function buildRow(pair, boost) {
      if (!pair || cleanNumber(pair.liquidity?.usd) < CONFIG.MIN_LIQUIDITY) return null;

      const price = cleanNumber(pair.priceUsd || 0);
      const liq = cleanNumber(pair.liquidity?.usd || 0);
      const fdv = cleanNumber(pair.fdv || 0);

      const age = pair.pairCreatedAt ? Math.round((Date.now() - pair.pairCreatedAt) / 60000) : 999999;

      const m5 = pair.txns?.m5 || {};
      const h6 = pair.txns?.h6 || {};
      const h24 = pair.txns?.h24 || {};

      const m5chg = pair.priceChange?.m5 || 0;

      let zone = '', soundFreq = 0, soundDur = 0.25;
      if (m5.sells > m5.buys * 2.8 || m5chg < -35 || liq / fdv < 0.05) {
        zone = 'RUG ⚠️'; soundFreq = 300; soundDur = 0.6;
      } else if (m5.sells > m5.buys * 1.8 && m5chg < -8) {
        zone = 'SELL ↓'; soundFreq = 500; soundDur = 0.4;
      } else if (m5.buys > m5.sells * 1.8 && m5chg > 9 && cleanNumber(pair.volume?.m5) > 8000) {
        zone = 'BUY ↑'; soundFreq = 1100; soundDur = 0.35;
      }

      let rugRisk = 0;
      if (liq / fdv < 0.05) rugRisk += 40;
      if (m5.sells > m5.buys * 2.5) rugRisk += 30;
      if (m5chg < -25) rugRisk += 20;
      if (liq < 10000) rugRisk += 20;
      rugRisk = Math.min(100, rugRisk);

      let riskLevel = 'Low', riskClass = 'risk-low';
      if (rugRisk >= 60) { riskLevel = 'High'; riskClass = 'risk-high'; }
      else if (rugRisk >= 30) { riskLevel = 'Medium'; riskClass = 'risk-med'; }

      const balance = walletAddress ? await getTokenBalance(boost.tokenAddress) : 0;
      const valueUsdRaw = balance * price;
      const valueUsd = valueUsdRaw > 0 ? `$${valueUsdRaw.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '–';

      const row = {
        mint: boost.tokenAddress,
        symbol: pair.baseToken.symbol || boost.symbol || '–',
        price: price.toFixed(6),
        fdv: fdv ? fdv.toLocaleString() : '–',
        liq: liq ? liq.toLocaleString() : '–',
        m5buys: m5.buys || 0,
        m5sells: m5.sells || 0,
        m5vol: (pair.volume?.m5 || 0).toLocaleString(),
        m5chg: m5chg.toFixed(1) + '%',
        h6buys: h6.buys || 0,
        h6sells: h6.sells || 0,
        h6vol: (pair.volume?.h6 || 0).toLocaleString(),
        h6chg: (pair.priceChange?.h6 || 0).toFixed(1) + '%',
        h24buys: h24.buys || 0,
        h24sells: h24.sells || 0,
        h24vol: (pair.volume?.h24 || 0).toLocaleString(),
        h24chg: (pair.priceChange?.h24 || 0).toFixed(1) + '%',
        age,
        zone,
        soundFreq,
        soundDur,
        boost: boost.totalAmount || boost.amount || '–',
        rugRisk,
        riskLevel,
        riskClass,
        buyFixed: CONFIG.FIXED_BUY_AMOUNTS.map(a => `<button class="buy-btn" onclick="buyToken('${boost.tokenAddress}', ${a})">${a} SOL</button>`).join(''),
        sellFixed: CONFIG.FIXED_SELL_PERCENTS.map(p => `<button class="sell-btn" onclick="sellToken('${boost.tokenAddress}', ${p})">${p}%</button>`).join(''),
        balance: balance.toFixed(2),
        valueUsd,
        ds: pair.url || `https://dexscreener.com/solana/${boost.tokenAddress}`,
        pump: `https://pump.fun/${boost.tokenAddress}`,
        jup: `https://jup.ag/swap/${CONFIG.SOL_MINT}-${boost.tokenAddress}`
      };

      const sentiment = estimateSentiment(row);
      row.sentimentLabel = sentiment.label;
      row.sentimentScore = sentiment.score;
      row.sentimentClass = sentiment.cls;

      row.score = calculateScore(row);

      return row;
    }

    function estimateSentiment(row) {
      // Simulated – in real use → LunarCrush / Birdeye / DexScreener social volume
      const m5Vol = cleanNumber(row.m5vol);
      const m5Chg = cleanNumber(row.m5chg);
      const boost = cleanNumber(row.boost);

      let score = 50;
      if (m5Chg > 20) score += 30;
      if (m5Vol > 100000) score += 25;
      if (boost > 2000) score += 20;
      if (m5.sells > m5.buys * 1.8) score -= 35;

      score = Math.max(0, Math.min(100, score));

      let label = 'Neutral', cls = 'sentiment-neutral';
      if (score >= 70) { label = 'Bullish'; cls = 'sentiment-bull'; }
      if (score <= 30) { label = 'Bearish'; cls = 'sentiment-bear'; }

      return { label, score, cls };
    }

    function calculateScore(row) {
      const m5Chg = cleanNumber(row.m5chg);
      const m5Vol = cleanNumber(row.m5vol);
      const buys = row.m5buys || 0;
      const sells = row.m5sells || 0;
      const liqRatio = cleanNumber(row.liq) / cleanNumber(row.fdv);
      const boost = cleanNumber(row.boost);
      const sentiment = row.sentimentScore / 100;

      const momentum = (m5Chg > 0 ? m5Chg : 0) * 0.35 + (m5Vol / 10000) * 0.25;
      const pressure = (buys / (sells + 1)) * 0.7;
      const safety = Math.min(liqRatio * 20, 1) * 0.4;
      const boostBonus = Math.min(boost / 1000, 3) * 0.3;
      const socialBonus = sentiment * 0.8;

      return momentum + pressure + safety + boostBonus + socialBonus;
    }

    async function loadData(silent = false) {
      DOM.error.textContent = '';
      DOM.status.textContent = walletAddress ? 'Scanning best tokens & balances...' : 'Scanning top boosted tokens...';

      try {
        const boosts = await fetchBoostedTokens();
        const rows = await Promise.all(
          boosts.map(b => buildRow(await fetchPair(b.tokenAddress), b))
        );

        // Deduplicate by mint
        const seen = new Set();
        const unique = rows.filter(r => r && !seen.has(r.mint) && (seen.add(r.mint), true));

        // Score & sort descending, take top N
        unique.sort((a, b) => b.score - a.score);
        currentData = unique.slice(0, CONFIG.MAX_DISPLAY_TOKENS);

        if (currentData.length === 0) {
          DOM.status.textContent = 'No high-potential coins right now – retry soon';
        } else {
          DOM.status.textContent = `Showing top ${currentData.length} strongest coins (momentum + social)`;
        }

        renderTable(currentData);
        DOM.lastUpdate.textContent = `Updated: ${new Date().toLocaleTimeString()} (auto 10s)`;
      } catch (err) {
        DOM.error.textContent = `Error: ${err.message}`;
      }
    }

    function renderTable(data) {
      DOM.tbody.innerHTML = '';
      let hasSound = false;

      if (data.length === 0) {
        DOM.tbody.innerHTML = '<tr><td colspan="24" style="padding:2rem;color:#ffcc00;">No high-potential boosted tokens right now</td></tr>';
        return;
      }

      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = row.zone.includes('BUY') ? 'buy-zone' :
                       row.zone.includes('SELL') ? 'sell-zone' :
                       row.zone.includes('RUG') ? 'rug-risk' : '';

        tr.innerHTML = `
          <td>${row.symbol}</td>
          <td>$${row.price}</td>
          <td>$${row.fdv}</td>
          <td>$${row.liq}</td>
          <td>${row.m5buys}</td><td>${row.m5sells}</td><td>$${row.m5vol}</td><td>${row.m5chg}</td>
          <td>${row.h6buys}</td><td>${row.h6sells}</td><td>$${row.h6vol}</td><td>${row.h6chg}</td>
          <td>${row.h24buys}</td><td>${row.h24sells}</td><td>$${row.h24vol}</td><td>${row.h24chg}</td>
          <td>${row.age}</td>
          <td>${row.zone || '–'}</td>
          <td>${row.boost}</td>
          <td><span class="risk-badge ${row.riskClass}">${row.riskLevel} (${row.rugRisk}%)</span></td>
          <td><span class="sentiment-badge ${row.sentimentClass}">${row.sentimentLabel} (${row.sentimentScore})</span></td>
          <td class="balance-cell">${row.balance > 0 ? row.balance : '0'}</td>
          <td class="value-cell">${row.valueUsd}</td>
          <td class="action-cell">
            ${row.buyFixed}
            <input type="number" step="0.01" min="0.001" placeholder="SOL" class="custom-input" id="buy-custom-${row.mint}">
            <button class="buy-btn" onclick="buyToken('${row.mint}', document.getElementById('buy-custom-${row.mint}').value)">Buy Custom</button>
            <br>
            ${row.sellFixed}
            <input type="number" step="0.01" min="0.001" placeholder="% or tokens" class="custom-input" id="sell-custom-${row.mint}">
            <button class="sell-btn" onclick="sellToken('${row.mint}', document.getElementById('sell-custom-${row.mint}').value)">Sell Custom</button>
          </td>
          <td>
            <a href="${row.ds}"   target="_blank" class="link">Dex</a>
            <a href="${row.pump}" target="_blank" class="link">Pump</a>
            <a href="${row.jup}"  target="_blank" class="link">Jup</a>
          </td>
        `;
        DOM.tbody.appendChild(tr);

        if (row.soundFreq > 0) {
          playSound(row.soundFreq, row.soundDur);
          hasSound = true;
        }
      });

      if (hasSound) setTimeout(() => playSound(1400, 0.15), 400);
    }

    function getNumericValue(row, key) {
      if (key === 'price')     return cleanNumber(row.price);
      if (key === 'fdv')       return cleanNumber(row.fdv);
      if (key === 'liq')       return cleanNumber(row.liq);
      if (key.endsWith('vol')) return cleanNumber(row[key]);
      if (key.endsWith('chg')) return cleanNumber(row[key]);
      if (key.endsWith('buys') || key.endsWith('sells')) return row[key] || 0;
      if (key === 'age')       return parseInt(row.age) || 999999;
      if (key === 'boost')     return parseInt(row.boost) || 0;
      if (key === 'balance')   return parseFloat(row.balance) || 0;
      if (key === 'valueUsd')  return cleanNumber(row.valueUsd);
      return 0;
    }

    function handleSort(event) {
      const th = event.target.closest('th.sortable');
      if (!th) return;

      const key = th.dataset.key;
      const dir = th.classList.contains('asc') ? 'desc' : 'asc';

      document.querySelectorAll('th.sortable').forEach(el => el.classList.remove('asc', 'desc'));
      th.classList.add(dir);

      currentData.sort((a, b) => {
        const va = getNumericValue(a, key);
        const vb = getNumericValue(b, key);
        return dir === 'desc' ? vb - va : va - vb;
      });

      renderTable(currentData);
    }

    // =============================================================================
    // START APPLICATION
    // =============================================================================

    DOM.refreshBtn.addEventListener('click', loadData);
    DOM.connectBtn.addEventListener('click', connectWallet);
    document.querySelector('thead').addEventListener('click', handleSort);

    loadData();
    setInterval(() => loadData(true), CONFIG.REFRESH_INTERVAL);
  </script>

  <!-- Solana web3.js -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</body>
</html>
